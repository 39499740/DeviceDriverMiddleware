# TWAIN扫描仪中间件 Windows应用程序 - 项目需求文档

## 项目概述
创建一个基于TWAIN的扫描仪中间件Windows应用程序，为Web应用提供扫描仪设备访问能力。

## 功能需求

### 1. 系统兼容性
- **最低支持系统**: Windows 7
- **运行环境**: 使用Windows自带环境，不依赖额外的.NET Framework安装
- **架构**: 支持x86和x64架构

### 2. 扫描仪支持
- **TWAIN协议**: 使用NTwain库操作扫描仪设备
- **设备管理**: 自动检测和列举可用的TWAIN扫描仪
- **扫描功能**: 支持多种扫描参数配置

### 3. WebSocket服务
- **默认端口**: 45677
- **协议支持**: WebSocket标准协议
- **API接口**: 提供完整的RESTful API和WebSocket接口
- **跨域支持**: 支持浏览器跨域访问

### 4. 系统托盘集成
- **托盘图标**: 显示应用程序状态
- **右键菜单功能**:
  - 显示当前运行端口号
  - 修改端口号（含合法性校验和占用检查）
  - 重置为默认端口号（45677）
  - 打开测试页面
  - 退出程序

### 5. 测试页面
- **Web界面**: 基于SDK的完整测试页面
- **功能覆盖**: 支持所有扫描仪操作和配置
- **实时预览**: 扫描结果实时显示

## 技术实现

### 1. 开发技术栈
- **编程语言**: C# (.NET Framework 4.5 - Windows 7兼容)
- **TWAIN库**: NTwain
- **WebSocket库**: WebSocketSharp或原生实现
- **HTTP服务**: 内置HTTP服务器
- **托盘组件**: System.Windows.Forms.NotifyIcon

### 2. 项目结构
```
TwainMiddleware/
├── src/                    # 源代码
│   ├── Program.cs         # 程序入口
│   ├── TwainService.cs    # TWAIN扫描仪服务
│   ├── WebSocketServer.cs # WebSocket服务器
│   ├── HttpServer.cs      # HTTP服务器
│   ├── TrayManager.cs     # 托盘管理
│   └── Config.cs          # 配置管理
├── sdk/                   # JavaScript SDK
├── web/                   # 测试页面
├── build/                 # 构建脚本
├── bin/                   # 编译输出
└── docs/                  # 文档
```

### 3. API设计

#### WebSocket接口
- `getScanners` - 获取扫描仪列表
- `scan` - 执行扫描操作
- `ping` - 心跳检测

#### HTTP接口
- `GET /api/scanners` - 获取扫描仪列表
- `POST /api/scan` - 执行扫描
- `GET /api/health` - 健康检查
- `GET /test` - 测试页面

### 4. 扫描参数支持
- **分辨率**: 可配置DPI
- **颜色模式**: 彩色、灰度、黑白
- **图像格式**: PNG、JPEG、TIFF、BMP
- **高级选项**: 亮度、对比度、自动旋转、自动裁剪

## 构建和部署

### 1. 构建脚本要求
- **无Visual Studio依赖**: 使用MSBuild命令行工具
- **编码处理**: 避免中文乱码问题
- **自动化程度**: 一键构建可执行文件

### 2. 版本控制
- **Git初始化**: 项目创建后立即初始化Git仓库
- **忽略文件**: 配置适当的.gitignore

### 3. 部署方式
- **绿色部署**: 单一可执行文件或最小依赖包
- **自动启动**: 支持开机自启动选项

## 配置管理

### 1. 配置文件
- **端口配置**: 可配置WebSocket服务端口
- **日志级别**: 可配置日志详细程度
- **扫描设置**: 默认扫描参数配置

### 2. 运行时配置
- **托盘菜单**: 动态修改端口号
- **即时生效**: 配置修改后自动重启服务

## 安全考虑

### 1. 本地访问限制
- **绑定地址**: 默认只绑定localhost
- **CORS策略**: 配置适当的跨域策略

### 2. 数据安全
- **图像数据**: Base64编码传输
- **临时文件**: 自动清理临时扫描文件

## 测试要求

### 1. 兼容性测试
- **Windows版本**: 测试Windows 7-11兼容性
- **扫描仪品牌**: 测试主流品牌扫描仪

### 2. 功能测试
- **WebSocket连接**: 连接稳定性测试
- **扫描功能**: 各种参数组合测试
- **错误处理**: 异常情况处理测试

## 文档要求

### 1. 用户文档
- **安装指南**: 详细的安装步骤
- **使用说明**: 功能使用说明
- **故障排除**: 常见问题解决方案

### 2. 开发文档
- **API文档**: 详细的接口说明
- **SDK文档**: JavaScript SDK使用指南
- **架构说明**: 系统架构和扩展指南

